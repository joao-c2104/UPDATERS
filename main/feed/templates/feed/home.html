{% extends "feed/base.html" %}
{% load static %}

{% block title %}Jornal do Commercio{% endblock %}

{% block body_class %}page-full-width{% endblock %}

{% block content %}
    {% if hero_article %}

        <a href="{{ hero_article.get_absolute_url }}" class="home-hero-link">
            <div class="home-hero">
                <div class="hero-image-container">
                    <img src="{{ hero_article.image.url }}" alt="{{ hero_article.title }}">
                </div>
                <div class="hero-text-container">
                    <h1 class="hero-title">
                        {{ hero_article.title }}
                    </h1>
                    <p class="hero-subheadline">
                        {{ hero_article.summary }}
                    </p>
                </div>
            </div>
        </a>
        {% else %}
        <div class="card">
            <div class="card_body" style="text-align: center;">
                <h2 class="card_title">Bem-vindo!</h2>
                <p>Ainda não há notícias para exibir na página inicial.</p>
            </div>
        </div>
    {% endif %}


    <div class="home-grid">
        {% for article in grid_articles %}

            <div class="grid-card-wrapper" data-article-id="{{ article.id }}">
                <a href="{{ article.get_absolute_url }}" class="grid-card">

                    <span class="grid-card-category">{{ article.category.name | default:'Sem Categoria' }}</span>

                    <img src="{{ article.image.url }}" alt="{{ article.title }}" class="grid-card-image">

                    <h3 class="grid-card-title">{{ article.title }}</h3>
                </a>

                {% if user.is_authenticated %}
                    <button class="home-grid-star-btn {% if article.favorites.all|length > 0 and user in article.favorites.all %}favorited{% endif %}"
                            data-article-id="{{ article.id }}"
                            title="{% if user in article.favorites.all %}Remover dos favoritos{% else %}Adicionar aos favoritos{% endif %}">
                        <svg class="star-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                {% endif %}
            </div>

        {% empty %}
            <p style="grid-column: 1 / -1;">Nenhuma outra notícia encontrada no momento.</p>
        {% endfor %}

    </div>

    <script>
        // CSRF token helper
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Toggle favorite via AJAX on home page
        document.addEventListener('DOMContentLoaded', function() {
            const starButtons = document.querySelectorAll('.home-grid-star-btn');

            starButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();

                    const articleId = this.dataset.articleId;

                    // Disable button during request
                    this.disabled = true;

                    fetch(`/api/favorite/toggle/${articleId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'),
                            'Content-Type': 'application/json',
                        },
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Toggle favorited class
                            if (data.is_favorited) {
                                this.classList.add('favorited');
                                this.title = 'Remover dos favoritos';
                            } else {
                                this.classList.remove('favorited');
                                this.title = 'Adicionar aos favoritos';
                            }
                        }
                        this.disabled = false;
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        this.disabled = false;
                    });
                });
            });
        });
    </script>

{% endblock %}