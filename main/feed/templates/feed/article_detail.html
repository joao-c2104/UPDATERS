{% extends "feed/base.html" %}

{% block body_class %}page-article-detail{% endblock %}

{% block title %}{{ article.title }} - Gen Z News{% endblock %}

{% block content %}
    <article class="card">

        <img class="card_image" src="{{ article.image.url }}" alt="{{ article.title }}">

        <div class="card_body">
            <div class="article-title-container">
                <h1 class="card_title" style="margin-bottom: 0;">{{ article.title }}</h1>
    
                <a href="{% url 'toggle_favorite' article.id %}" class="favorite-star-button">
                {% if is_favorited %}
                    ⭐ {% else %}
                    ☆ {% endif %}
                </a>
            </div>

            <p style="color: #666; font-size: 0.9rem; margin-bottom: 24px;">
                Por {{ article.author }} <br>
                Publicado em {{ article.publication_date|date:"d/m/Y \à\s H:i" }}
            </p>
            <div class="article-content">
                {{ article.content|linebreaks }}
            </div>

            <!-- Comments Section -->
            <div class="comments-section" style="margin-top: 48px;">
                <div class="comments-header">
                    <button id="comments-toggle" class="comments-toggle-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M21 15C21 15.5304 20.7893 16.0391 20.4142 16.4142C20.0391 16.7893 19.5304 17 19 17H7L3 21V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H19C19.5304 3 20.0391 3.21071 20.4142 3.58579C20.7893 3.96086 21 4.46957 21 5V15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span id="comments-count">0</span> comentários
                    </button>
                </div>

                <div id="comments-panel" class="comments-panel" style="display: none;">
                    <!-- Comment Input -->
                    {% if user.is_authenticated %}
                    <div class="comment-input-container">
                        <textarea
                            id="comment-input"
                            class="comment-textarea"
                            placeholder="Escreva seu comentário..."
                            maxlength="300"
                        ></textarea>
                        <div class="comment-input-footer">
                            <span id="char-counter" class="char-counter">0 / 300</span>
                            <button id="submit-comment" class="submit-comment-btn" disabled>
                                Comentar
                            </button>
                        </div>
                        <div id="comment-error" class="comment-error" style="display: none;"></div>
                    </div>
                    {% else %}
                    <div class="comment-login-message">
                        <p>Você precisa estar <a href="{% url 'login_user' %}">logado</a> para comentar.</p>
                    </div>
                    {% endif %}

                    <!-- Comments List -->
                    <div id="comments-list" class="comments-list">
                        <div class="comments-loading">Carregando comentários...</div>
                    </div>
                </div>
            </div>

            <a href="{% url 'article-list' %}" class="card_button" style="margin-top: 32px;">Voltar</a>
        </div>
    </article>

    <script>
        const articleId = {{ article.id }};
        const isAuthenticated = {{ user.is_authenticated|yesno:"true,false" }};

        // DOM Elements
        const commentsToggle = document.getElementById('comments-toggle');
        const commentsPanel = document.getElementById('comments-panel');
        const commentsCount = document.getElementById('comments-count');
        const commentsList = document.getElementById('comments-list');
        const commentInput = document.getElementById('comment-input');
        const charCounter = document.getElementById('char-counter');
        const submitBtn = document.getElementById('submit-comment');
        const commentError = document.getElementById('comment-error');

        // Toggle comments panel
        commentsToggle.addEventListener('click', () => {
            const isVisible = commentsPanel.style.display !== 'none';
            commentsPanel.style.display = isVisible ? 'none' : 'block';

            if (!isVisible) {
                loadComments();
            }
        });

        // Character counter
        if (commentInput) {
            commentInput.addEventListener('input', () => {
                const length = commentInput.value.length;
                charCounter.textContent = `${length} / 300`;
                submitBtn.disabled = length === 0 || length > 300;

                if (length > 300) {
                    charCounter.style.color = 'var(--color-primary)';
                } else {
                    charCounter.style.color = 'var(--color-text-secondary)';
                }
            });
        }

        // Submit comment
        if (submitBtn) {
            submitBtn.addEventListener('click', async () => {
                const content = commentInput.value.trim();

                if (!content || content.length > 300) {
                    return;
                }

                submitBtn.disabled = true;
                submitBtn.textContent = 'Enviando...';
                commentError.style.display = 'none';

                try {
                    const response = await fetch(`/api/articles/${articleId}/comments/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({ content })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        commentInput.value = '';
                        charCounter.textContent = '0 / 300';
                        loadComments();
                        updateCommentCount();
                    } else {
                        showError(data.error || 'Erro ao enviar comentário.');
                    }
                } catch (error) {
                    showError('Erro ao enviar comentário. Tente novamente.');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Comentar';
                }
            });
        }

        // Load comments
        async function loadComments() {
            commentsList.innerHTML = '<div class="comments-loading">Carregando comentários...</div>';

            try {
                const response = await fetch(`/api/articles/${articleId}/comments/`);
                const data = await response.json();

                if (data.comments.length === 0) {
                    commentsList.innerHTML = '<div class="comments-empty">Nenhum comentário ainda. Seja o primeiro a comentar!</div>';
                } else {
                    commentsList.innerHTML = data.comments.map(comment => `
                        <div class="comment-item">
                            <div class="comment-header">
                                <span class="comment-author">${escapeHtml(comment.author)}</span>
                                <span class="comment-date">${formatDate(comment.created_at)}</span>
                            </div>
                            <div class="comment-content">${escapeHtml(comment.content)}</div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                commentsList.innerHTML = '<div class="comments-error">Erro ao carregar comentários.</div>';
            }
        }

        // Update comment count
        async function updateCommentCount() {
            try {
                const response = await fetch(`/api/articles/${articleId}/comments/count/`);
                const data = await response.json();
                commentsCount.textContent = data.count;
            } catch (error) {
                console.error('Error updating comment count:', error);
            }
        }

        // Show error message
        function showError(message) {
            commentError.textContent = message;
            commentError.style.display = 'block';
        }

        // Format date
        function formatDate(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'agora';
            if (diffMins < 60) return `${diffMins}min atrás`;
            if (diffHours < 24) return `${diffHours}h atrás`;
            if (diffDays < 7) return `${diffDays}d atrás`;

            return date.toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Initialize comment count on page load
        updateCommentCount();
    </script>
{% endblock %}